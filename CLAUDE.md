# Linear Project 설정

## Git 저장소

- **원격 저장소**: `git@github.com:wineny/slack-linear-sync.git`
- **GitHub URL**: https://github.com/wineny/slack-linear-sync

---

## Linear 프로젝트 캐시

프로젝트 이름으로 요청 시 아래 테이블에서 ID를 먼저 찾아서 사용할 것. API 호출 최소화.

| 프로젝트명 | ID | 팀 |
|-----------|-----|-----|
| 전사 SSOT 구축 및 Linear 연결 | 1a0e3d9a-d90d-468e-9697-89923c048aaa | Education |
| Linear 최신 유지 자동화 | 6f0017df-e36d-4477-ab47-4127ff5f2c80 | Education |
| Linear 업무 에이전트 자동화 | 14b0371c-dbd2-4c33-bf8e-bc567b88d0bb | Education |
| Linear 업무 분석 자동화 | 6485f12d-fa48-450f-8f3d-b4f8d6d35ddb | Education |
| 사내 AX를 위한 최신 사례 수집 자동화 | 2c7ea0c1-e756-4df8-ada3-cf15c6e464bb | Education |
| 프로젝트 관리툴로 AI와 협업하기 | 798b594a-9311-4ea5-8160-41ee1919ebce | Education |
| 지피터스 커뮤니티 유지 및 관리 | 1ed824f1-9473-4e34-9f35-648010d5e960 | Education |
| 사내 AX 방법 검증 | c96a03e4-c8f8-4bf4-be4b-a527a4997781 | Education |
| 클코+확장앱으로 세일즈 자동화 | 9bca26c0-06ec-4022-839d-7b4e5a81f823 | Education |
| [워크샵 마케팅] B2C 강의 마케팅 전략 수립 및 진행 | 47795190-e9a6-4c0c-aa1a-1442454fdaed | Education |
| [AX] 콘텐츠 파이프라인 구축 | cb21cab4-0e3f-422c-8704-506c7ad3da34 | Education |
| AX 교육 주제 고객 구체화 & 검증 퍼널 구축 | f20fbda3-0d6c-4dd8-8220-2543d7d7f984 | Education |
| 교육팀의 바이브 코딩을 위한 서버 구축 | 6a6a3ea5-7d30-4e90-ac2f-8bce39b0884c | Education |
| 팀 대시보드 구축 | 77c23044-9648-4743-98c9-0fe4396e3dac | Education |
| 교육팀 자동화 프로세스 정리&개선 | 17799775-8cfa-4473-9224-a84d0ead5814 | Education |
| AI스터디 20기 준비 및 운영 | 49517d3c-4b3d-4252-bb54-b15025db1908 | Education |
| 사내 AX로 교육 주제 2개 구체화 | 7b4adfd5-b86d-463a-837e-474b6c31ef86 | Education |
| 사업화 과제를 위한 Rona 기능 개발 | dc6a43c0-9443-4637-a617-b0d964668aed | Product |
| 개발 인프라 리소스 정리 및 계정 이전 | 491e0699-5af7-4218-9a1b-b52210f72ccc | Product |
| AX 실습 생성기 - 개발 및 사용자 검증 | 026e40ea-0d02-4f43-bf1f-0b4ddba3df15 | Product |
| 사내 바이브 코딩 개발자 가이드 | 9c2623fd-fd86-439e-a6a0-0d00a46dd552 | Product |
| 사내 Skill 공유 최소 기능 제품 | f5eae1b3-91d7-453e-b08a-1d6122ec9fd7 | Product |
| Rona 문서화 및 정리 | 8be55dd6-4f29-4e21-b0c2-2e9fae409d3e | Product |
| 바이브 코더를 위한 Portal 개선 | 24f05189-89b4-41ce-9111-83dd199b1b25 | Product |
| [AX] 랜딩페이지 자동화 | eabc6df9-17b7-4af9-8a83-428c51c5d9e7 | Product |
| 로나 CBT 런칭 준비 | 9348860e-55b0-454a-82b5-4c6de036f1f8 | Product |
| 로나 검증 기능 통합 개발 | e2720352-85e2-4feb-9984-9fa9af742059 | Product |
| Rona AI 고도화, 답변 품질 개선 검증 | 1dfef7dd-cb84-4f51-8d09-f14f6d8f481e | Product |

## 팀 정보

| 팀명 | ID | Key |
|------|-----|-----|
| Product | 432fe835-1dee-4921-8728-ce74fc74b370 | DEV |
| Education | e108ae14-a354-4c09-86ac-6c1186bc6132 | EDU |

## 워크플로우 상태 (Education 팀)

| 상태 | ID | 타입 |
|------|-----|------|
| Triage | 2014ff48-051b-45e9-a46c-241a52b86331 | triage |
| Todo | 6dc4154e-3a35-43d2-ac44-e3d66df85c9b | unstarted |
| In Progress | e983f615-0869-4573-86ad-5c878cc60ba6 | started |
| In Review | 83ff207c-5afd-4f56-8a8d-87834c822451 | started |
| Done | 8af3af6f-d60f-4d57-bac2-fcd557488d93 | completed |
| Canceled | 34457b78-5e48-4368-b9aa-f0ae38cea2ca | canceled |
| Duplicate | eefbbc02-b940-4176-9d31-c448cc53f64e | canceled |
| Backlog | 51733663-9daa-4b7b-9614-69ee5055c2a3 | backlog |

## 워크플로우 상태 (Product 팀)

| 상태 | ID | 타입 |
|------|-----|------|
| Triage | 8ff1a544-316e-4e48-a0fa-1c247b191d01 | triage |
| Todo | 83873853-84b8-4f88-b9bf-34215124562e | unstarted |
| In Progress | 95a29c36-3f48-4fa1-affe-f189e0540bda | started |
| In Review | 866e4377-d989-46e5-8425-fe2f90a3520e | started |
| Done | 9d6a479a-c003-4e62-b46c-b403c2de5f88 | completed |
| Canceled | 732dbc1b-9f2f-41ea-a668-6d9947728f5a | canceled |
| Duplicate | f61f07b6-6ebc-4c94-991d-4051b409a8f0 | canceled |
| Backlog | 129a0111-352e-4d10-814e-821940382d67 | backlog |

## 사용 가이드

프로젝트 이름으로 이슈 생성 요청 시:
1. 위 캐시 테이블에서 프로젝트 ID 검색
2. 매칭되면 바로 `createIssue` 호출
3. 매칭 안 되면 `getProjects` API 호출 후 캐시 업데이트

**캐시 갱신**: 새 프로젝트 추가 시 이 파일 업데이트 필요

---

## 이슈 생성 규칙

### 제목 규칙

**형식**: `대상 - 구체적 내용`

**체크리스트**:
- [ ] 제목만 보고 어떤 작업인지 파악 가능한가?
- [ ] 검색 시 찾기 쉬운 키워드가 포함되어 있는가?
- [ ] 50자 이내로 간결한가?

**좋은 예시**:
- "로그인 - 소셜로그인 세션 만료 오류 수정"
- "결제 API - 응답 시간 500ms 이하로 단축"
- "대시보드 - 실시간 알림 기능 추가"

**나쁜 예시**:
- "기능 추가" (무슨 기능?)
- "버그 수정 필요" (어떤 버그?)
- "개선 작업" (뭘 개선?)

### 기본 상태값

이슈 생성 시 `stateId`를 **Todo**로 설정:
- Education 팀: `6dc4154e-3a35-43d2-ac44-e3d66df85c9b`
- Product 팀: `83873853-84b8-4f88-b9bf-34215124562e`

### Cycle 표시 형식

Cycle 선택/표시 시 날짜 정보를 함께 표시:

**형식**: `Cycle {number} ({M월 D일} - {M월 D일}) · {상태}`

**상태 구분**:
- Current: 오늘 날짜가 startsAt~endsAt 사이
- Upcoming: startsAt이 오늘 이후
- Previous: endsAt이 오늘 이전

**예시**:
- "Cycle 71 (1월 10일 - 1월 16일) · Current"
- "Cycle 72 (1월 17일 - 1월 23일) · Upcoming"
- "Cycle 70 (1월 3일 - 1월 9일) · Previous"

### Description 템플릿

Linear 이슈 생성 시 **반드시** 아래 템플릿을 따라 description을 작성할 것.
현재 대화 세션의 맥락을 상세히 요약하여 포함.

### 템플릿

```markdown
## 배경
<!-- 이 이슈가 나오게 된 맥락. 대화에서 논의된 문제점이나 니즈 -->

## 논의 내용
<!-- Claude Code와 나눈 대화 요약 -->
- **문제 인식**: (어떤 문제/불편함이 있었는지)
- **검토한 방안들**: (논의된 해결책들 나열)
- **선택한 방향**: (최종 결정과 그 이유)

## 완료된 작업
<!-- 이미 수행한 작업이 있다면 기록 -->
- [ ] 작업1
- [x] 작업2 (완료)

## 요구사항
<!-- 이 이슈에서 해야 할 일 -->
- 요구사항 1
- 요구사항 2

## 참고 자료
<!-- 관련 파일, 링크, 코드 등 -->
- 파일: `path/to/file`
- 관련 이슈: EDU-XXXX

## 기대 효과
<!-- 이 작업이 완료되면 어떤 가치가 있는지 -->
```

### 작성 규칙

1. **대화 맥락 필수 포함**: 이슈만 보고도 "왜 이 작업이 필요한지" 파악 가능해야 함
2. **구체적 수치 포함**: 토큰 절감량, 시간 단축 등 정량적 효과 명시
3. **이미 한 작업 체크**: 대화 중 완료한 작업은 체크박스로 표시
4. **관련 파일 링크**: 수정/생성한 파일 경로 포함
5. **후속 작업 명확화**: 남은 TODO를 명확히 정의

---

## Linear Capture 앱 (Electron)

### 개요
macOS용 스크린샷 캡처 → Linear 이슈 생성 앱

**경로**: `linear-capture/`

**실행 방법**:
```bash
cd linear-capture
npm run start
```

**단축키**: `⌘+Shift+L` (전역 핫키)

### 기술 스택
- Electron + TypeScript
- R2 (Cloudflare) - 이미지 업로드
- AI 분석 - Anthropic Haiku 4.5 / Gemini 3 Flash

### 주요 파일
| 파일 | 설명 |
|------|------|
| `src/main/index.ts` | 메인 프로세스, IPC 핸들러, 캡처 플로우 |
| `src/renderer/index.html` | UI (이슈 생성 폼) |
| `src/services/anthropic-analyzer.ts` | Claude Haiku 4.5 분석기 |
| `src/services/gemini-analyzer.ts` | Gemini Flash 분석기 |
| `src/services/linear-client.ts` | Linear API 클라이언트 |
| `src/services/r2-uploader.ts` | Cloudflare R2 업로더 |
| `src/services/capture.ts` | macOS screencapture 래퍼 |

### AI 분석 설정

**모델 우선순위**: Anthropic Haiku → Gemini (fallback)

**환경변수** (`.env`):
```
ANTHROPIC_API_KEY=sk-ant-...  # Claude Haiku 4.5
GEMINI_API_KEY=AIza...        # Gemini 3 Flash (백업)
```

**모델명**:
- Anthropic: `claude-haiku-4-5-20251001`
- Gemini: `gemini-3-flash-preview` (기본), `gemini-2.0-flash` (빠름)

### 최적화 현황 (2025-01)

**병렬 처리**: R2 업로드 + AI 분석 동시 실행 (`Promise.all`)
- 기존: 순차 실행 (업로드 → 분석)
- 개선: 병렬 실행으로 ~1-2초 단축

**UI 모델 선택**: 드롭다운에서 Haiku/Gemini 전환 가능, 재분석 버튼 제공

### 개발 브랜치
| 브랜치 | 설명 |
|--------|------|
| `main` | 안정 버전 |
| `feature/ai-speed-optimization` | AI 속도 최적화 (병렬 처리, 모델 선택 UI) |

---

## 이슈 생성 출처 구분 (Webhook payload 기준)

Linear Webhook에서 이슈 생성 이벤트(`type: "Issue"`, `action: "create"`) 수신 시, 출처를 구분하는 방법.

### 구분 기준

| 출처 | 구분자 | 비고 |
|------|--------|------|
| **Linear 직접 생성** | `integrationSourceType` 없음 + description 짧거나 빈 문자열 | 마감일 체크 대상 |
| **slack-linear-sync** | description에 `"Slack"` + `"채널에서 접수된 질문"` 포함 | 마감일 체크 제외 |
| **Linear Slack 앱** | `integrationSourceType: "slack"` | 마감일 체크 제외 (UI에서 due date 설정 불가) |

### Payload 예시

**Linear 직접 생성**:
```json
{
  "actor": { "type": "user", "name": "윤누리" },
  "data": {
    "botActor": null,
    "description": ""
    // integrationSourceType 없음
  }
}
```

**slack-linear-sync (우리 자동화)**:
```json
{
  "actor": { "type": "user", "name": "윤누리" },
  "data": {
    "botActor": null,
    "description": "## 배경\n\nSlack `00-ai개발-질문` 채널에서 접수된 질문입니다..."
    // integrationSourceType 없음
  }
}
```

**Linear Slack 앱**:
```json
{
  "actor": { "type": "user", "name": "윤누리" },
  "data": {
    "botActor": null,
    "integrationSourceType": "slack",
    "description": "@ny said:\n\n> ..."
  }
}
```

### 구분 로직 (TypeScript)

```typescript
function getIssueSource(payload: any): 'direct' | 'slack-linear-sync' | 'linear-slack-app' {
  const issue = payload.data;

  // Linear Slack 앱
  if (issue.integrationSourceType === 'slack') {
    return 'linear-slack-app';
  }

  // slack-linear-sync (우리 자동화)
  if (issue.description?.includes('Slack') &&
      issue.description?.includes('채널에서 접수된 질문')) {
    return 'slack-linear-sync';
  }

  // Linear에서 직접 생성
  return 'direct';
}
```

### 주의사항

- **Linear Slack 앱**: UI에서 due date 설정이 불가능하므로, 마감일 누락 확률이 높음
- **slack-linear-sync**: Slack 질문 기반이라 마감일 개념이 애매함
- **마감일 체크 대상**: `direct`로 생성된 이슈 중 `state.name !== 'Backlog'`인 경우만

---

## Linear Rona Bot (Cloudflare Workers)

### 개요
Cycle 기반 이슈 리마인더 봇 - 계획적인 로나

**경로**: `linear-rona-bot/`

**배포 URL**: `https://linear-rona-bot.ny-4f1.workers.dev`

**Cron 스케줄**: 평일 09:30 KST (UTC 00:30) - `30 0 * * 1-5`

### 기술 스택
- Cloudflare Workers + Hono
- KV Storage (토큰, 중복 방지, 사용자 설정)
- Linear GraphQL API

### 주요 파일
| 파일 | 설명 |
|------|------|
| `src/index.ts` | Hono 라우터 + Cron export |
| `src/cron/cycle-reminder.ts` | Cron 핸들러 |
| `src/services/linear-client.ts` | GraphQL 클라이언트 |
| `src/services/reminder-service.ts` | 리마인더 로직 |
| `src/utils/message-templates.ts` | 잔소리 메시지 템플릿 |
| `src/types/index.ts` | 타입 + 팀/상태 상수 |

### 리마인더 대상 조건

**포함 (Todo, In Progress, In Review 상태)**:
- Cycle 미등록 이슈 (`cycle === null`)
- Cycle 지난 이슈 (`cycle.endsAt < today`)

**제외**:
| 상태 | 이유 |
|------|------|
| Done | 완료됨 |
| Backlog | 아직 계획 안 됨 |
| Canceled | 취소됨 |
| Duplicate | 중복 |
| Triage | 분류 전 |

**추가 제외**:
- slack-linear-sync로 생성된 이슈
- 이번 주 이미 리마인드한 이슈 (KV 중복 방지)

### 현재 설정 (Phase 1)

```typescript
// reminder-service.ts
const TEST_MODE = true;  // ny@gpters.org만 대상
const MAX_COMMENTS_PER_RUN = 30;  // 배치 제한
```

**테스트 사용자**: ny@gpters.org (`686312fd-f7a2-49d2-89cd-592f4600eb40`)

### 사용자 빈도 설정

| 빈도 | 실행 요일 | KV 키 |
|------|----------|-------|
| daily | 월~금 | `user-config:{userId}` |
| mon-wed-fri | 월, 수, 금 | |
| weekly | 월요일만 (기본값) | |
| off | 알림 끔 | |

### 중복 방지 KV

```
키: reminder:{issueId}:{type}:{weekNumber}
값: ISO timestamp
TTL: 7일
예: reminder:abc123:no-cycle:2026-W03
```

### 개발 명령어

```bash
cd linear-rona-bot
npm run dev          # 로컬 개발
npm run deploy       # 배포

# Cron 수동 테스트 (로컬)
curl "http://localhost:8789/cdn-cgi/handler/scheduled"
```

### OAuth 토큰 관리

**중요**: Linear OAuth는 **refresh token rotation** 사용
- refresh 시 새 access_token + **새 refresh_token** 발급
- 이전 refresh_token은 즉시 **revoke**됨

**토큰 갱신 로직** (`src/utils/token-manager.ts`):
```typescript
// 새 토큰 발급 시 refresh_token도 함께 저장
if (result.refreshToken) {
  await kv.put('refresh_token', result.refreshToken);
}
```

**재인증 필요 시**:
1. https://linear-rona-bot.ny-4f1.workers.dev/oauth/authorize 접속
2. "already installed" 표시되면 → Manage → 연결 해제 → 다시 인증
3. 토큰 상태 확인: `/oauth/status`

**주의**: refresh_token 저장 누락 시 "Refresh token revoked" 오류 발생

### 다음 계획

- [ ] 중복 방지 로직 검증 (다음 월요일 Cron 실행 시)
- [ ] 개인 빈도 설정 (`@로나 매일 알림` 댓글로 설정)
- [ ] 전체 팀 확장 (`TEST_MODE = false`)
